---
title: "Alcohol Consumption in Schools"
author: "Hypothesis Heroes - Drew Davison, Lisa Zhang, Ellie Culman, Austin Chang"
date: "11/14/23"
format: pdf
execute: 
  warning: false
  message: false
  echo: false
editor: visual
---

```{r}
#| label: load packages and data
#| message: FALSE
library(tidyverse)
library(tidymodels)
library(kableExtra)
library(patchwork)
library(MASS)
library(knitr)
library(rms)
```

## Introduction and data

All around the world, underage drinking among students is a significant public health issue and takes a huge toll on the quality of students' lives and education. There is plenty of existing documentation on the effects of socioeconomic status on risky drinking behavior amongst college students. For example, a paper by Susan E. Collins, PhD, professor and licensed clinical psychologist, found that individuals with lower socioeconomic status as well as people of racial and ethnic minorities and homelessness experience greater alcohol-related consequences. Additionally, studies from the National Institutes of Health have found that "aspects of college life---such as unstructured time, widespread availability of alcohol, inconsistent enforcement of underage drinking laws, and limited interactions with parents and other adults" drives up rates of underage drinking, and "college students have higher binge-drinking rates and a higher incidence of driving under the influence of alcohol than their noncollege peers." Since most existing literature on underage student drinking focuses on college students, we wanted to examine the factors contributing to drinking amongst secondary school students. Our research question is as follows:

How do social indicators affect student alcohol consumption in secondary schools?

We hypothesize that factors like gender, familial status, family and school support, and other social and economic indicators will strongly influence the rates that secondary school students consume alcohol and that increased alcohol consumption is correlated with their school performance.

```{r}
alc <- read_csv("~/project-Hypothesis-Heroes/data/student-por.csv")
```

This data is from a Kaggle public dataset, originally sourced from the UC Irvine Machine Learning Repository. The data consists of information collected in 2008 on secondary school students from two schools in Portugal: Gabriel Pereira and Mousinho da Silveira. There are 649 observations, each one being a student, and 33 variables which cover a range of characteristics about each student's family, education, social situation, alcohol consumption, and grades in their Portuguese language class. Some key variables we will be examining are sex, male or female, Pstatus, whether their parents are together or apart, schoolsup, whether or not their school provides them extra academic support, famsup, whether or not their family provides them extra academic support, Mjob and Fjob, the categories that their parents' jobs fall under, freetime and studytime, the amount of free time after school and amount of time spent studying on a scale of 1-5, number of absences, and amount of class failures, on a scale of 1-4. Our response variable is Walc, which is the students' average weekend alcohol consumption, on a scale of 1-5, with 5 being very high.

```{r}
#| fig-height: 10
#| fig-width: 15

walchist <- alc |>
  ggplot(aes(x = Walc)) +
  geom_histogram(stat = "count") +
  labs(x = "Weekend Alcohol Consumption",
       y = "Frequency",
       title = "Distribution of Weekend Alcohol Consumption Scores",
       subtitle = "On a scale of 1 (very low) to 5 (very high)")

alcline <- alc %>%
  ggplot(aes(x = Dalc)) +
  geom_line(aes(y = ..count.., color = "Dalc"), stat = 'count') +
  geom_line(aes(x = Walc, y = ..count.., color = "Walc"), stat = 'count') +
  labs(x = "Alcohol Consumption",
       y = "Frequency",
       color = "Weekday or Weekend",
       title = "Distribution of Alcohol Consumption Scores Weekday vs. Weekend",
       subtitle = "On a scale of 1 (very low) to 5 (very high)") +
  scale_color_manual(
    values = c("Dalc" = "blue", "Walc" = "red"),
    labels = c("Weekday", "Weekend")
  )
 
walcstudy <- alc |>
  ggplot(aes(x = studytime, y = Walc)) +
  geom_point() +
  geom_jitter() +
  geom_smooth(method = "lm") +
  labs(x = "Study Time",
       y = "Weekend Alcohol Consumption Scores",
       title = "Study Time vs. Weekend Alcohol Consumption Scores",
       subtitle = "On a scale of 1 to 4: 1 = <2 hours, 2 = 2-5 hours, 3 = 5-10 hours, 4 = >10 hours")

walcfamsup <- alc |>
  ggplot(aes(x = famsup, y = Walc)) +
  geom_boxplot() +
  labs(x = "Family Educational Support (Yes or No)",
       y = "Weekend Alcohol Consumption Scores",
       title = "Family Educational Support vs. Weekend Alcohol Consumption Scores")

(walchist | alcline) / (walcstudy | walcfamsup)
```

## Methodology

We are using a multivariable linear regression to examine the effects of the predictor variables sex, Pstatus, schoolsup, famsup, Mjob, Fjob, freetime, studytime, absences, and failures on the response variable Walc, or weekend alcohol consumption. We are using a linear model rather than logistic since Walc is not binary. We started by performing a stepAIC function for preliminary model selection which allowed us to narrow down predictors with a significant effect. We then ran a VIF function to determine multicollinearity and found that our predictors were satisfactorily independent of one another. We considered interactions between studytime and absences, freetime and goout, as well as famrel and famsize. These interaction were chosen based on their real-life contexts (for instance, the effect of family size would likely change depending on familial relationship). The interactions did not significantly improve the r-squared or rmse values as well as greatly increasing collinearity. As such, we selected Model 1 as our model.

In our model we also considered including interactions between freetime and studytime, failures and studytime, failures and absences, as well as famsup and Mjob and famsup and Fjob. In our model we used step_dummy() to create dummy variables for all categorical variables, step_interact() to create all of our interaction variables, and step_zv() to remove all variables with only one value.

### Split Data into Testing and Training Data

```{r}
#| label: split-data
set.seed(210)
alc_split <- initial_split(alc, prop = 0.75)
alc_train <- training(alc_split)
alc_test <- testing(alc_split)
```

### Split Training Data in 5 Folds for Cross-Validation

```{r}
set.seed(210)
folds <- vfold_cv(alc_train, v = 5) 
folds
```

### StepAIC Model

```{r}
#|label: stepAIC-model
lm1 <- lm(Walc ~ .-Dalc, data = alc_train)

stepAIC(lm1, direction = "backward",trace = 0) |>
  tidy() |>
  kable(digits = 3)
```

### Model 1

```{r}
alc_rec1 <- recipe(Walc ~ sex + Fjob + studytime + absences + Medu + 
                     Fedu + Mjob + famsize + reason + nursery +
                     famrel + freetime + goout, data = alc_train) |>
  step_dummy(all_nominal_predictors()) |>
  step_zv(all_predictors()) |>
  step_center(absences)

alc_rec1
```

#### Model Specification + Workflow 1

```{r}
alc_spec1 <- linear_reg() |>
  set_engine("lm")

alc_wflow1 <- workflow() |>
  add_model(alc_spec1) |>
  add_recipe(alc_rec1) 

alc_fit1 <- alc_wflow1 |>
  fit(data = alc_train)

tidy(alc_fit1) |>
  kable(digits = 3)


```

#### VIF Multicollinearity Test 1

```{r}
alc_fit_model_1 <- extract_fit_parsnip(alc_fit1)
vif(alc_fit_model_1$fit) |>
  tidy() |>
  kable(digits = 3)
```

#### RMSE and R-Squared from 5-Fold Cross Validation 1

```{r}
calc_model_stats <- function(x) {
  glance(extract_fit_parsnip(x)) |>
    select(adj.r.squared, AIC, BIC)
}

alc_fit_cv1 <- alc_wflow1 |>
  fit_resamples(resamples = folds,
                control = control_resamples(extract = calc_model_stats))

collect_metrics(alc_fit_cv1, summarize = TRUE) |>
  kable(digits = 3)
```

### Model 2 with Interactions

```{r}
#| label: create-recipe
alc_rec2 <- recipe(Walc ~ sex + Fjob + studytime + absences + Medu + 
                     Fedu + Mjob + famsize + reason + nursery +
                     famrel + freetime + goout, data = alc_train) |>
  step_dummy(all_nominal_predictors()) |>
  step_interact(terms = ~ starts_with("studytime"):starts_with("absences")) |>
  step_interact(terms = ~ starts_with("freetime"):starts_with("goout")) |>
  step_interact(terms = ~ starts_with("famsize"):starts_with("famrel")) |>
  step_center(absences) |>
  step_zv(all_predictors())

alc_rec2
```

#### Model Specification + Workflow 2

```{r}
alc_spec <- linear_reg() |>
  set_engine("lm")

alc_wflow2 <- workflow() |>
  add_model(alc_spec) |>
  add_recipe(alc_rec2) 

alc_fit2 <- alc_wflow2 |>
  fit(data = alc_train)

tidy(alc_fit2) |>
  kable(digits = 3)


```

#### VIF Multicollinearity Test 2

```{r}
alc_fit_model_2 <- extract_fit_parsnip(alc_fit2)
vif(alc_fit_model_2$fit) |>
  tidy() |>
  kable(digits = 3)
```

#### RMSE and R-Squared from 5-Fold Cross Validation 2

```{r}
calc_model_stats <- function(x) {
  glance(extract_fit_parsnip(x)) |>
    select(adj.r.squared, AIC, BIC)
}

alc_fit_cv2 <- alc_wflow2 |>
  fit_resamples(resamples = folds,
                control = control_resamples(extract = calc_model_stats))

collect_metrics(alc_fit_cv2, summarize = TRUE) |>
  kable(digits = 3)
```

### Applying Model 1 to Testing Data

```{r}
alc_fit <- alc_wflow1 |>
  fit(data = alc_test)

tidy(alc_fit)|>
  kable(digits = 3)
```

```{r}

alc_test_pred <- predict(alc_fit1, alc_test) |>
  bind_cols(alc_test)

rmse(alc_test_pred, truth = Walc, estimate = .pred) |>
  kable(digits = 3)
rsq(alc_test_pred, truth = Walc, estimate = .pred) |>
  kable(digits = 3)
```

## Results

Our model assumes independence between predictors, linearity, and the other assumptions of a multilinear regression model. These assumptions were supported by our diagnostic tests as well as the VIF test. Our final R squared was .211 and our final RMSE was 1.125. This suggests that our model accounts for around 21% of the total variation in weekend alcohol consumption with an error of about 1.09.

The coefficients with significant p-values are the following:\
\
Medu: +.340 - As each level of Mother's education increases by one unit the expected Walc score increases by .340 on average.

famrel: -.296 - As each level of quality of family relationship increases by one unit the expected Walc score decreases by -.296 on average.

goout: +.365 - As each level of going out with friends increases by one unit the expected Walc score increases by .365 on average.

sex_M: +.872 - If the individual is Male, the expected Walc score increases by .872 compared to the baseline of sex_W on average.

Mjob_services: -.716 - If the individual's Mother works in the civil services industry, the expected Walc score decreases by .716 compared to the baseline of Mjob_at_home on average.

### Conclusion

From our data analysis, we conclude that family relationships has the biggest impact on weekend alcohol consumption. Extrapolating from this, we emphasize the importance of strong family dynamics for school aged children. This drives us to consider more research into what makes children feel supported by their families and how parents' employment impacts daily decisions. We also found it interesting that men are more likely to participate in alcohol consumption at school age rather than women. We believe that may have something to local gender norms and allows for further research into young male substance abuse and mental health.
