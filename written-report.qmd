---
title: "Alcohol Consumption in Schools"
author: "Hypothesis Heroes - Drew Davison, Lisa Zhang, Ellie Culman, Austin Chang"
date: "11/14/23"
format: pdf
execute: 
  warning: false
  message: false
  echo: false
editor: visual
---

```{r}
#| label: load packages and data
#| message: FALSE
library(tidyverse)
library(tidymodels)
library(kableExtra)
library(patchwork)
library(MASS)
library(knitr)
library(rms)
```

## Introduction and data

All around the world, underage drinking among students is a significant public health issue and takes a huge toll on the quality of students' lives and education. There is plenty of existing documentation on the effects of socioeconomic status on risky drinking behavior amongst college students. For example, a paper by Susan E. Collins, PhD, professor and licensed clinical psychologist, found that individuals with lower socioeconomic status as well as people of racial and ethnic minorities and homelessness experience greater alcohol-related consequences. Additionally, studies from the National Institutes of Health have found that "aspects of college life---such as unstructured time, widespread availability of alcohol, inconsistent enforcement of underage drinking laws, and limited interactions with parents and other adults" drives up rates of underage drinking, and "college students have higher binge-drinking rates and a higher incidence of driving under the influence of alcohol than their noncollege peers." Since most existing literature on underage student drinking focuses on college students, we wanted to examine the factors contributing to drinking amongst secondary school students. Our research question is as follows:

How do social indicators affect student alcohol consumption in secondary schools?

We hypothesize that factors like gender, familial status, family and school support, and other social and economic indicators will strongly influence the rates that secondary school students consume alcohol and that increased alcohol consumption is correlated with their school performance.

```{r}
alc <- read_csv("~/project-Hypothesis-Heroes/data/student-por.csv")
```

This data is from a Kaggle public dataset, originally sourced from the UC Irvine Machine Learning Repository. The data consists of information collected in 2008 on secondary school students from two schools in Portugal: Gabriel Pereira and Mousinho da Silveira. There are 649 observations, each one being a student, and 33 variables which cover a range of characteristics about each student's family, education, social situation, alcohol consumption, and grades in their Portuguese language class. Some key variables we will be examining are sex, male or female, Pstatus, whether their parents are together or apart, schoolsup, whether or not their school provides them extra academic support, famsup, whether or not their family provides them extra academic support, Mjob and Fjob, the categories that their parents' jobs fall under, freetime and studytime, the amount of free time after school and amount of time spent studying on a scale of 1-5, number of absences, and amount of class failures, on a scale of 1-4. Our response variable is Walc, which is the students' average weekend alcohol consumption, on a scale of 1-5, with 5 being very high.

```{r}
#| fig-height: 10
#| fig-width: 15

walchist <- alc |>
  ggplot(aes(x = Walc)) +
  geom_histogram(stat = "count") +
  labs(x = "Weekend Alcohol Consumption",
       y = "Frequency",
       title = "Distribution of Weekend Alcohol Consumption Scores",
       subtitle = "On a scale of 1 (very low) to 5 (very high)")

alcline <- alc %>%
  ggplot(aes(x = Dalc)) +
  geom_line(aes(y = ..count.., color = "Dalc"), stat = 'count') +
  geom_line(aes(x = Walc, y = ..count.., color = "Walc"), stat = 'count') +
  labs(x = "Alcohol Consumption",
       y = "Frequency",
       color = "Weekday or Weekend",
       title = "Distribution of Alcohol Consumption Scores Weekday vs. Weekend",
       subtitle = "On a scale of 1 (very low) to 5 (very high)") +
  scale_color_manual(
    values = c("Dalc" = "blue", "Walc" = "red"),
    labels = c("Weekday", "Weekend")
  )
 
walcstudy <- alc |>
  ggplot(aes(x = studytime, y = Walc)) +
  geom_point() +
  geom_jitter() +
  geom_smooth(method = "lm") +
  labs(x = "Study Time",
       y = "Weekend Alcohol Consumption Scores",
       title = "Study Time vs. Weekend Alcohol Consumption Scores",
       subtitle = "On a scale of 1 to 4: 1 = <2 hours, 2 = 2-5 hours, 3 = 5-10 hours, 4 = >10 hours")

walcfamsup <- alc |>
  ggplot(aes(x = famsup, y = Walc)) +
  geom_boxplot() +
  labs(x = "Family Educational Support (Yes or No)",
       y = "Weekend Alcohol Consumption Scores",
       title = "Family Educational Support vs. Weekend Alcohol Consumption Scores")

(walchist | alcline) / (walcstudy | walcfamsup)
```

## Methodology

We are using a multivariable linear regression to examine the effects of the predictor variables sex, Pstatus, schoolsup, famsup, Mjob, Fjob, freetime, studytime, absences, and failures on the response variable Walc, or weekend alcohol consumption. We are using a linear model rather than logistic since Walc is not binary. In our model we are also including interactions between freetime and studytime, failures and studytime, failures and absences, as well as famsup and Mjob and famsup and Fjob. In our model we used step_dummy() to create dummy variables for all categorical variables, step_interact() to create all of our interaction variables, and step_zv() to remove all variables with only one value.

## Results

```{r}
#| label: split-data
set.seed(210)
alc_split <- initial_split(alc, prop = 0.75)
alc_train <- training(alc_split)
alc_test <- testing(alc_split)

set.seed(210)
folds <- vfold_cv(alc_train, v = 5) 
folds
```

```{r}
set.seed(8272)
alc_folds <- vfold_cv(alc_train, v = 10)
```

```{r}
#| label: specify-model
alc_spec <- linear_reg() |>
  set_engine("lm")
  
alc_spec
```

### StepAIC Model

```{r}
lm1 <- lm(Walc ~ sex + Pstatus + schoolsup + famsup + Mjob + Fjob + freetime + studytime + absences + failures, data = alc_train)

stepAIC(lm1, direction = "backward") |>
  tidy() 
```

### Model 1

```{r}
alc_rec1 <- recipe(Walc ~ sex + Fjob + studytime + absences, data = alc) |>
  step_dummy(all_nominal_predictors()) |>
  step_zv(all_predictors())

alc_rec1
```

```{r}
alc_spec1 <- linear_reg() |>
  set_engine("lm")

alc_wflow1 <- workflow() |>
  add_model(alc_spec1) |>
  add_recipe(alc_rec1) 


alc_fit1 <- alc_wflow1 |>
  fit(data = alc_train)

tidy(alc_fit1) |>
  kable(digits = 3)

alc_fit_model_1 <- extract_fit_parsnip(alc_fit1)
vif(alc_fit_model_1$fit)
```

```{r}
calc_model_stats <- function(x) {
  glance(extract_fit_parsnip(x)) |>
    select(adj.r.squared, AIC, BIC)
}

alc_fit_rsq1 <- alc_wflow1 |>
  fit_resamples(resamples = folds,
                control = control_resamples(extract = calc_model_stats))
collect_metrics(alc_fit_rsq1, summarize = TRUE)
```

### Model 2 with Interactions

```{r}
#| label: create-recipe
alc_rec2 <- recipe(Walc ~ sex + Fjob + studytime + absences, data = alc) |>
  step_dummy(all_nominal_predictors()) |>
  step_interact(terms = ~ starts_with("studytime"):starts_with("absences")) |>
  step_zv(all_predictors())

alc_rec2
```

```{r}
alc_spec <- linear_reg() |>
  set_engine("lm")

alc_wflow2 <- workflow() |>
  add_model(alc_spec) |>
  add_recipe(alc_rec2) 




alc_fit2 <- alc_wflow2 |>
  fit(data = alc_train)

tidy(alc_fit2) |>
  kable(digits = 3)

alc_fit_model_2 <- extract_fit_parsnip(alc_fit2)
vif(alc_fit_model_2$fit)
```

```{r}
calc_model_stats <- function(x) {
  glance(extract_fit_parsnip(x)) |>
    select(adj.r.squared, AIC, BIC)
}

alc_fit_rsq2 <- alc_wflow2 |>
  fit_resamples(resamples = folds,
                control = control_resamples(extract = calc_model_stats))
collect_metrics(alc_fit_rsq2, summarize = TRUE)
```

::: callout-important
Before you submit, make sure your code chunks are turned off with `echo: false` and there are no warnings or messages with `warning: false` and `message: false` in the YAML.
:::
